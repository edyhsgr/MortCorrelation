# Extract the division-level, both-sex tables if necessary
need.to.build.df = !exists('state.df')
included_states = c('MN','UT','SC','MS')
included_states = state.abb
if (need.to.build.df) {
file_list = paste0('States/',included_states,'/',
included_states,'_bltper_1x1.csv')
unzip(zipfile='lifetables.zip', files=file_list, junkpaths=TRUE)
state.df = data.frame()
for (this.state in included_states) {
this.file = paste0(this.state,'_bltper_1x1.csv')
this.df = read.csv(this.file, stringsAsFactors = FALSE)
this.df$Age = 0:110 # make numeric
state.df = rbind( state.df, this.df)
file.remove(this.file)
}
} # if need.to.build
#--------------------------
# calculate the prob of death
# between ages 0 and 5
#--------------------------
q5.df =
state.df %>%
group_by(PopName,Year) %>%
summarize( q5 = 1000 * (1 - lx[6]/lx[1])) %>%
ungroup()
sample_n(q5.df, 10)
filter(q5.df, Year==1959) %>% sample_n(10)
source('~/GitHub/USA-mortality/state-level-q5-both-sexes.R', echo=TRUE)
movie
setwd("~/GitHub/USA-mortality")
#---------------------------------------------
# Carl Schmertmann
# created 21 Oct 18
# altered 21 Oct 18
#
# probability of outliving e(x)
#---------------------------------------------
rm(list=ls())
library(tidyverse)
USA = read.table('USA_bltper_1x1.txt', skip=2, stringsAsFactors = FALSE,
header=TRUE)
USA$Age = 0:110  # make Age numeric
head(USA)
#---------------------------------------------
# Carl Schmertmann
# created 21 Oct 18
# altered 21 Oct 18
#
# probability of outliving e(x)
#---------------------------------------------
rm(list=ls())
library(tidyverse)
USA = read.table('USA_bltper_1x1.txt', skip=2, stringsAsFactors = FALSE,
header=TRUE)
USA$Age = 0:110  # make Age numeric
USA$PopName = 'USA'
dim(USA)
tail(USA)
max(USA$Year)
keep.df = USA %>%
filter( Year == 2016)
keep.df
keep.df = USA %>%
filter( Year == 2016)
keep.df
keep.df
prob_outlive = function(z, ex_column, dx_column) {
ez = ex_column[ages==z]
sum(dx_column[ages >= (z+ez)] / dx_column[ages >= z])
}
ex_column = keep.df$ex
dx_column = keep.df$dx
prob_outlive(0, ex_column, dx_column)
ages=0:110
prob_outlive(0, ex_column, dx_column)
prob_outlive = function(z, ex_column, dx_column) {
ez = ex_column[ages==z]
sum(dx_column[ages >= (z+ez)]) / sum(dx_column[ages >= z])
}
prob_outlive(0, ex_column, dx_column)
sapply(ages, function(z) prob_outlive(z,ex_column,dx_column))
sapply(ages, function(z) prob_outlive(z,ex_column,dx_column)) -> pp
plot(ages,pp)
plot(ages,pp, type='s')
abline(h=.50, col='red')
ex[1]
ex_column[1]
dx_column[ages > 78.91]
dx_column[ages > 78.91] / lx[1]
sum(dx_column[ages > 78.91])
ex_column[2]
ex_column[1]
View(keep.df)
lx_column = keep.df$lx
length(lx_column)
approx(x=ages,y=lx_column, xout=seq(0,110,.1))
plot( approx(x=ages,y=lx_column, xout=seq(0,110,.1)))
lx.hat = approx(x=ages,y=lx_column, xout=seq(0,110,.1)))
lx.hat = approx(x=ages,y=lx_column, xout=seq(0,110,.1))
lx.hat
lx.hat = approx(x=ages,y=lx_column, xout=seq(0,110,.01))
lx.hat
age_grid =seq(0,110,.01))
age_grid =seq(0,110,.01)
lx.hat = approx(x=ages,y=lx_column, xout=age_grid
)
lx[ ex_column[1]]
lx.hat[ age_grid == ex_column[1]]
age_grid == ex_column[1]
ex_column[1]
which(age_grid == ex_column[1])
lx.hat[which(age_grid == ex_column[1])]
lx.hat = approx(x=ages,y=lx_column, xout=age_grid)$y
lx.hat[which(age_grid == ex_column[1])]
lx.hat[which(age_grid == ex_column[2])]
lx.hat[which(age_grid == 1+ex_column[2])]
sapply(0:100, function(z) { lx.hat[which(age_grid == z+ex_column[z+1])]})
lapply(0:100, function(z) { lx.hat[which(age_grid == z+ex_column[z+1])]})
sapply(0:100, function(z) { lx.hat[which(age_grid == z+ex_column[z+1])]}) %>% unlist()
sapply(0:100, function(z) { lx.hat[which(age_grid == z+ex_column[z+1])]}) %>% unlist() -> tmp
plot(tmp)
sapply(0:100, function(z) { lx.hat[which(age_grid == z+ex_column[z+1])] / lx_column[1+z]}) %>% unlist() -> tmp
plot(tmp)
plot(tmp, type='o'
)
plot(tmp, type='l')
abline(h=.50, col=2)
plot(0:100,tmp, type='l')
sapply(0:100, function(z) { lx.hat[which(age_grid == z+ex_column[z+1])] / lx_column[1+z]}) %>% unlist() -> tmp
str(tmp)
df = keep.df
df
age_grid = seq(from=0, to=110, by=.01)
age_grid
sapply(0:100, function(z) {i=which(age_grid == (z+ez[z+1]))})
sapply(0:100, function(z) {i=which(age_grid == (z+ez[z+1])); return(i)})
sapply(0:100, function(z) {i=which(age_grid == (z+ex[z+1])); return(i)})
sapply(0:100, function(z) {i=which(age_grid == (z+df$ex[z+1])); return(i)})
sapply(0:100, function(z) {i=which(age_grid == (z+df$ex[z+1])); return(i)}) %>% unlist()
tmp = mutate(df, aad=x+ex)
tmp = mutate(df, aad=Age+ex)
tmp
head(tmp)
tmp = mutate(tmp, ix = which(age_grid==aad))
)
#---------------------------------------------
# Carl Schmertmann
# created 21 Oct 18
# altered 21 Oct 18
#
# probability of outliving e(x)
#---------------------------------------------
rm(list=ls())
library(tidyverse)
ages = 0:110
USA = read.table('USA_bltper_1x1.txt', skip=2, stringsAsFactors = FALSE,
header=TRUE)
USA$Age = ages # make Age numeric
USA$PopName = 'USA'
head(USA)
df = USA %>% filter(Year==2016) %>% mutate(aad=Age+ex)
head(df)
df = USA %>% filter(Year==2016) %>% mutate(aad=Age+ex)
head(df)
df = USA %>% filter(Year==2016) %>% mutate(aad=Age+ex,
lx_aad = approx(x=Age,y=lx,xout=aad))
df = USA %>% filter(Year==2016) %>% mutate(aad=Age+ex,
lx_aad = approx(x=Age,y=lx,xout=aad))
df = USA %>% filter(Year==2016) %>% mutate(aad=Age+ex,
lx_aad = approx(x=Age,y=lx,xout=aad))
df = USA %>%
filter(Year==2016) %>%
mutate(aad=Age+ex)
df$lx_aad = approx(x=df$Age,y=df$lx,xout=df$aad))
df = USA %>%
filter(Year==2016) %>%
mutate(aad=Age+ex)
df$lx_aad = approx(x=df$Age,y=df$lx,xout=df$aad)
df$lx
df$aad
df$Age
approx(x=df$Age,y=df$lx,xout=df$aad)
df = USA %>%
filter(Year==2016) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y)
df
head(df)
df = USA %>%
filter(Year==2016) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y)/lx[1])
df = USA %>%
filter(Year==2016) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y/lx[1])
df
head(df)
df = USA %>%
filter(Year==2016) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y/lx[1],
p_outlive = lx_aad/lx)
head(df)
df = USA %>%
filter(Year==2016) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y/lx[1],
p_outlive = lx_aad)
head(df)
plot(df$Age, df$p_outlive)
tail(df)
outlive_ex = function(df) {
return(df %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y/lx[1],
p_outlive = lx_aad)
)
}
p_outlive = function(df) {
tmp = df %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y/lx[1],
p_outlive = lx_aad)
return(tmp$p_outlive)
}
keep.df = USA %>%
group_by(Year) %>%
mutate(p = p_outlive())
keep.df = USA %>%
group_by(Year) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y/lx[1],
p_outlive = lx_aad)
head(keep.df)
View(keep.df)
for (i in keep.df$Year) {
tmp = filter(keep.df, Year==i)
plot( keep.df$Age, keep.df$p_outlive, type='l',main=i)
}
windows(record=TRUE)
for (i in keep.df$Year) {
plot( keep.df$Age, keep.df$p_outlive, type='l',main=i)
}
filter(keep.df, Age==0)
filter(keep.df, Age==0) %>% select(Age,Year,p_outlive())
filter(keep.df, Age==0) %>% select(Age,Year,p_outlive)
keep.df = USA %>%
group_by(Year) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y/lx[1],
p_outlive = lx_aad,
u = rep(runif(1),111))
keep.df = USA %>%
group_by(Year) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=Age,y=lx,xout=aad)$y/lx[1],
p_outlive = lx_aad,
u = rep(runif(1),111))
tmp = filter(keep.df, Age==0)
plot(tmp$Year, tmp$p_outlive)
tmp = filter(keep.df, Age==60)
plot(tmp$Year, tmp$p_outlive)
tmp = filter(keep.df, Age==90)
plot(tmp$Year, tmp$p_outlive)
tmp1 = filter(keep.df, Year==1960)
tmp1 = filter(keep.df, Year %in% c(1960,1985,2010))
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=Year, group=Year))
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=Year, group=Year)) + geom_line()
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year)) + geom_line()
)
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line()
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line() + geom_hline(yintercept = .50)
tmp1 = keep.df)
tmp1 = keep.df
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line() + geom_hline(yintercept = .50)
tmp1 = filter(keep.df, (Year %% 10 == 0))
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line() + geom_hline(yintercept = .50)
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2) + geom_hline(yintercept = .50)
tmp1 = filter(keep.df, (Year %% 10 == 5))
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2) + geom_hline(yintercept = .50)
tmp1 = filter(keep.df, Year %in% seq(1935,2015,20))
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2) + geom_hline(yintercept = .50)
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2) + geom_hline(yintercept = c(0,.50))
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2) + geom_hline(yintercept = c(0,.50)) + xlim(0,100)
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2) + geom_hline(yintercept = c(0,.50)) + xlim(0,100) + theme_bw()
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2,alpha=.60) + geom_hline(yintercept = c(0,.50)) + xlim(0,100) + theme_bw()
keep.df = USA %>%
group_by(Year) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=Age,y=lx,xout=aad)$y,
p_outlive = lx_aad/lx,
u = rep(runif(1),111))
tmp1 = filter(keep.df, Year %in% seq(1935,2015,20))
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2,alpha=.60) + geom_hline(yintercept = c(0,.50)) + xlim(0,100) + theme_bw()
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2,alpha=.60) + geom_hline(yintercept = c(0,.50))  + theme_bw()
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2,alpha=.60) + geom_hline(yintercept = .50) + xlim(0,100) + theme_bw()
tmp1 = filter(keep.df, Year %in% seq(1935,2015,40))
ggplot(data=tmp1,aes(x=Age, y=p_outlive, color=factor(Year))) + geom_line(lwd=2,alpha=.60) + geom_hline(yintercept = .50) + xlim(0,100) + theme_bw()
#---------------------------------------------
# Carl Schmertmann
# created 21 Oct 18
# altered 21 Oct 18
#
# probability of outliving e(x)
#---------------------------------------------
rm(list=ls())
library(tidyverse)
ages = 0:110
USA = read.table('USA_bltper_1x1.txt', skip=2, stringsAsFactors = FALSE,
header=TRUE)
USA$Age = ages # make Age numeric
USA$PopName = 'USA'
# function to take a data.frame composed of one country-year
# life table and return the probabilities of surviving longer
# than e(x) at each age x in 0...100
p_outlive = function(df) {
tmp = df %>%
mutate(aad=Age+ex,
lx_aad= approx(x=df$Age,y=df$lx,xout=df$aad)$y/lx[1],
p_outlive = lx_aad)
return(tmp$p_outlive)
}
df = USA %>%
group_by(Year) %>%
mutate(aad=Age+ex,
lx_aad= approx(x=Age,y=lx,xout=aad)$y,
p_outlive = lx_aad/lx,
u = rep(runif(1),111))
keep.df = df %>%
filter(Year %in% seq(1935,2015,40))
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive, color=factor(Year))) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = .50) +
xlim(0,100) +
theme_bw()
G
# ggplot( data=keep.df, aes(x=Age, y=JPNadv, group=Year, color=factor(Year))) +
#          geom_point() +
#          geom_line() +
#          geom_hline( yintercept = 0) +
#          scale_color_manual(values=c('red','royalblue','darkgreen')) +
#          scale_x_continuous(breaks=seq(0,110,10)) +
#          scale_y_continuous(breaks=seq(-2,6,0.5), limits=c(-2,6.2)) +
#          theme_bw() +
#          labs(title='How Much Longer can Japanese Women expect to live\nthan American Women?\nby Age',
#               x='Age',
#               y='Expected Years of Extra Life for Japanese',
#               caption='ex[JPN females]-ex[USA females]       http://mortality.org') +
#          guides(color=FALSE) +
#          geom_text( aes(x=15, y=5.8), label='in 2015', size=6, col='darkgreen') +
#          geom_text( aes(x=15, y=3.0), label='in 1990', size=6, col='royalblue') +
#          geom_text( aes(x=15, y=-1.0), label='in 1965', size=6, col='red')
#
# ggsave(file='JPN vs USA.png')
source('~/GitHub/USA-mortality/outlive-e0.R', echo=TRUE)
keep.df = df %>%
filter(Year %in% seq(1935,2015,40)) %>%
mutate(Year = as.factor(Year))
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive, color=Year)) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = .50) +
xlim(0,100) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive, color=Year)) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = .50) +
xlim(0,100) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_discrete(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
keep.df = df %>%
filter(Year %in% seq(1935,2015,40)) %>%
mutate(Year = as.factor(Year))
keep.df = df %>%
ungroup() %>%
filter(Year %in% seq(1935,2015,40)) %>%
mutate(Year = as.factor(Year))
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive, color=Year)) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = .50) +
xlim(0,100) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_discrete(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive, color=Year)) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = .50) +
xlim(0,100) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive, color=Year)) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = c(.40,.50,.60), lty=2) +
xlim(0,100) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive, color=Year)) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = c(.40,.50,.60), lty=2) +
xlim(0,100) +
ylim(.35,.65) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive, color=Year)) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = c(.40,.50,.60), lty=c(2,1,2)) +
xlim(0,100) +
ylim(.35,.65) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
keep.df = df %>%
ungroup() %>%
filter(Year %in% 2016)
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive)) +
geom_line(lwd=2,alpha=.80) +
geom_hline(yintercept = c(.40,.50,.60), lty=c(2,1,2)) +
xlim(0,100) +
ylim(.35,.65) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive)) +
geom_line(lwd=2,alpha=.80, color='red') +
geom_hline(yintercept = c(.40,.50,.60), lty=c(2,1,2)) +
xlim(0,100) +
ylim(.35,.65) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA 2016, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive)) +
geom_line(lwd=2,alpha=.80, color='red') +
geom_hline(yintercept = c(.40,.50,.60), lty=c(2,1,2)) +
xlim(0,100) +
ylim(.39,.61) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA 2016, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw()
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive)) +
geom_line(lwd=2,alpha=.80, color='red') +
geom_hline(yintercept = c(.40,.50,.60), lty=c(2,1,2)) +
xlim(0,100) +
ylim(.39,.61) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA 2016, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw() +
theme(text=element_text(face='bold', size='15'))
G
G = ggplot(data=keep.df,
aes(x=Age, y=p_outlive)) +
geom_line(lwd=2,alpha=.80, color='red') +
geom_hline(yintercept = c(.40,.50,.60), lty=c(2,1,2)) +
xlim(0,100) +
ylim(.39,.61) +
labs(title='Probability of Outliving Remaining Life Expectancy\nUSA 2016, Both Sexes Combined',
x='Age', y='Prob',
caption='Source: Human Mortality Database;   http://mortality.org') +
scale_color_manual(values=c('red','royalblue','darkgreen')) +
theme_bw() +
theme(text=element_text(face='bold', size=15))
G
